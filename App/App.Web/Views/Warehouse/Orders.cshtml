@using App.Models.Orders;
@model CartViewModel
@{
	ViewBag.Title = "Склад";
}


<!-- breadcrumbs start-->
<section class="breadcrumbs">
	<div class="container">
		<div class="text-center breadcrumbs-item">
			<h1>Склад</h1><a href="#">начало</a><i class="fa fa-angle-right"></i><a href="#">Склад</a>
		</div>
	</div>
</section>
<!-- ! breadcrumbs end-->
<!-- content-->
<div class="container mt-40">
	<div class="row">
		<div class="col-md-8 col-md-offset-2">
			<h2 class="title-section mb-0 mt-0 text-center">Текущи проекти</h2>
			<div class="cws_divider with-plus short-3 center mb-20 mt-10"></div>
			<p class="text-center mb-0">Тук може да разгледате Вашите текущи проекти, както и други неща които сте добавили във Вашият склад. Може да направите поръчка, да изтриете даден проект, да определите дали искате да се възползвате от услугата монтаж, както да видите кога е направен вашият проект и какъв е неговият статус.</p>
		</div>
	</div>
</div>
<div class="container warehouse-container">
	<div class="row">
		<div class="col-md-12">
			<a href="" class="cws-button with-icon alt calculator-head-button">Склад<i class="fa fa-home calculator-icon"></i></a>
		</div>
	</div>
	<div class="row gallery-row">
		@if (Model.Orders.Count() > 0)
			{
			<div class="col-md-7">
				@foreach (OrderViewModel order in Model.Orders)
				{
				<!-- Wardrobe item -->
					<div class="row">
						<div class="col-md-4">
							<div class="gallery-row-image-wrapper">
								@if (order.SketchImage.Length > 0)
								{
									@Html.ByteImage(order.SketchImage, "warehouse-image", "", order.Title + " Скица", order.Title + " Скица")
								}
								else
								{
									<img src="~/content/img/warehouse/waiting.jpg" alt="@order.Title" />
								}
								<i class="fa fa-angle-double-right"></i>
								<span>Скица</span>
							</div>
						</div>
						<div class="col-md-4">
							<div class="gallery-row-image-wrapper">
								@if (order.DesignImage.Length > 0)
								{
									@Html.ByteImage(order.DesignImage, "warehouse-image", "", order.Title + " 3D модел", order.Title + " 3D модел")
								}
								else
								{
									<img src="~/content/img/warehouse/waiting.jpg" alt="@order.Title" />
								}
								<i class="fa fa-angle-double-right"></i>
								<span>Модел</span>
							</div>
						</div>
						<div class="col-md-4">
							<div class="gallery-row-image-wrapper">
								@if (order.ResultImage.Length > 0)
								{
									@Html.ByteImage(order.ResultImage, "warehouse-image", "", order.Title + " 3D модел", order.Title + " 3D модел")
								}
								else
								{
									<img src="~/content/img/warehouse/waiting.jpg" alt="@order.Title" />
								}
								<span>Резултат</span>
							</div>
						</div>
					</div>
					<div class="row mt-30">
						<div class="col-md-6">
							<p>
								Име: @order.Title<br />
								@if (order.State == OrderState.Done)
								{ @Html.Raw(string.Format("Направен на: {0}<br />", order.CompleteDate.ToLongDateString()));
								}
								@if (order.Price > 0)
								{ @Html.Raw(string.Format("Цена: {0} лв", order.Price));
								}
								@if (order.State == OrderState.New)
								{ @Html.Raw("<strong>Вашата заявка се обработва!</strong>") }
							</p>
						</div>
						@if (order.State == OrderState.WaitingClientResponse || order.State == OrderState.Done)
						{
							<div class="col-md-2 col-md-offset-4">
								<span class="count-label">Брой:</span>
								<div class="selection-box" style="background-color:white;">
									<select>
										<option>1</option>
										<option>2</option>
										<option>3</option>
										<option>4</option>
										<option>5</option>
										<option>6</option>
										<option>7</option>
										<option>8</option>
										<option>9</option>
										<option>10</option>
									</select>
								</div>
								<div class="checkbox mt-10">
									<input id="checkbox1" type="checkbox" value="None" name="check">
									<label for="checkbox1">Монтаж</label>
								</div>
							</div>
						}
					</div>
					if ((order.State == OrderState.WaitingClientResponse || order.State == OrderState.Done) && !order.IsInCart)
					{
						<div class="row" style="padding-right:20px;padding-top:20px;">
							<div class="col-xs-3 col-xs-offset-9">
								<div class="alert alert-danger add-cart-fail">
									<p>Неуспешно!</p>
								</div>
								<div class="alert alert-success add-cart-success">
									<p>Успешно!</p>
								</div>
								<p class="add-cart-loading"><i class="fa fa-refresh fa-spin fa-fw"></i>Зареждане ...</p>
								@Ajax.ActionLink(
									"Добави в кошницата",
									"AddCartItem",
									new { orderId = order.Id },
									new AjaxOptions
									{
										HttpMethod = "Post",
										OnBegin = "addToCartBegin",
										OnFailure = "addToCartFail",
										OnSuccess = "addToCartSuccess"
									},
									new { @class = "cws-button alt order-now-add-button" })
								@*<button class="cws-button alt order-now-add-button" data-order-id="@order.Id" href="#">Добави в кошницата</button>*@
							</div>
						</div>
					}
					<div class="cws_divider with-plus long mt-40 mb-40"></div>
				<!-- Wardrobe item end -->
				}
			</div>
			<div class="col-md-4 col-sm-offset-1">
				<div id="order-container" class="order-container">
					<h3>Кошница</h3>
					<div class="basket-full-view">
						<table>
							<thead>
								<tr>
									<td>Продукт</td>
									<td>бр.</td>
									<td>цена</td>
									<td></td>
								</tr>
							</thead>
							<tbody class="basket-items-container">
								@foreach (OrderViewModel order in Model.Cart)
								{
									<tr>
										<td>@order.Title</td>
										<td>@order.Count</td>
										<td>@order.Price &nbsp;лв</td>
										<td>
											@Ajax.ActionLink(
												" ",
												"RemoveCartItem",
												new { orderId = order.Id },
												new AjaxOptions
												{
													HttpMethod = "Post",
													OnBegin = "removeFromCartBegin",
													OnFailure = "removeFromCartFail",
													OnSuccess = "removeFromCartSuccess"
												},
												new { @class = "fa fa-remove" })
										</td>
									</tr>
								}
								@*<tr>
										<td>Трикрилен гардероб</td>
										<td>1&nbsp;бр</td>
										<td>580&nbsp;лв</td>
										<td><a href="#"><i class="fa fa-remove"></i></a></td>
									</tr>
									<tr>
										<td>Гардероб с плъзгащи се врати</td>
										<td>1&nbsp;бр</td>
										<td>852&nbsp;лв</td>
										<td><a href="#"><i class="fa fa-remove"></i></a></td>
									</tr>*@
							</tbody>
						</table>
						<table>
							<thead>
								<tr>
									<td></td>
								</tr>
							</thead>
							<tr>
								<td>Общо цена:</td>
								<td>2548 лв</td>
							</tr>
							<tr>
								<td>Доставка:</td>
								<td>0 лв</td>
							</tr>
							<tr>
								<td>Монтаж:</td>
								<td>58 лв</td>
							</tr>
						</table>
						<table>
							<thead>
								<tr>
									<td></td>
								</tr>
							</thead>
							<tr class="total-price-row">
								<td>Общо:</td>
								<td>3512 лв</td>
							</tr>
							<tr>
								<td></td>
								<td><a class="cws-button white" href="#">Поръчай</a></td>
							</tr>
						</table>
					</div>
					<div class="basket-empty-view">
						<i class="fa fa-shopping-basket"></i>
						<p>Вашата кошница е празна!</p>
						<p>Използвайте бутона "Добави в кошницата" под за да добавите артикул в кошницата.</p>
					</div>
				</div>

			</div>
			}
			else
			{
			<div class="col-md-6 col-md-offset-3">
				<div class="panel panel-default">
					<div class="panel-heading">
						<h3 class="panel-title">Склада е празен</h3>
					</div>
					<div class="panel-body">
						<p><strong>Вашият склад</strong> е празен!</p>
						<p>
							Когато направите поръчка при нас - тук ще може да следите нейния статус. Ако не сте сигурни как точно да направите скицата за вашия проект може да прочетете в нашата <a href="/make">"Направи"</a> секция.
						</p>
						<p>Ако сте готови да направите поръчка, да качите вашите скици от тук:</p>
						<a href="@Url.Action("Make", "Orders")" class="cws-button gray alt pull-right">Качи скици</a>
					</div>
				</div>
			</div>
			}

	</div>
</div>
<div style="clear:both;margin-top:60px;">&nbsp;</div>
<!-- ! content-->

@section Scripts {
	<script src="~/Scripts/jquery.unobtrusive-ajax.min.js"></script>
	<script>

		$(document).ready(function () {
			// sticky basket
			if ($(window).width() > 1200) {
				var cartContainer = $('#order-container');
				var originalLeftPosition = cartContainer.offset().left;
				var originalWidth = cartContainer.outerWidth();

				$(window).scroll(function () {
					var documentScrollPosition = $(document).scrollTop();
					if (600 < documentScrollPosition) {
						if (!cartContainer.hasClass('sticky-cart')) {
							cartContainer.addClass('sticky-cart');
							cartContainer.css('left', originalLeftPosition);
							cartContainer.css('width', originalWidth);
						}
					} else {
						if (cartContainer.hasClass('sticky-cart')) {
							cartContainer.removeClass('sticky-cart');
							cartContainer.css('left', '-50px');
						}
					}
				})
			}

			// basket logic
			updateBasketView();

		});

		function updateBasketView() {
			var basketEmptyView = $('.basket-empty-view');
			var basketFullVIew = $('.basket-full-view');
			var basketItemsContainer = $('.basket-items-container');

			if (basketItemsContainer.children().length > 0) {
				basketFullVIew.show();
				basketEmptyView.hide();
			} else {
				basketFullVIew.hide();
				basketEmptyView.show();
			}
		}

		// ajaxActionLink functions:
		function addToCartBegin(xhr, request) {
			var clickedBtn = $(this);
			var nearestLoadingElement = clickedBtn.prev('.add-cart-loading');

			clickedBtn.removeAttr('href');
			clickedBtn.css('opacity', '0.5');
			nearestLoadingElement.show();

			debugger;
			// TODO: get the count and installation variables from the inputs!!!
			request.url = request.url + '&orderCount=' + 10 + '&installation=true';
		}

		function addToCartFail() {
			var clickedBtn = $(this);
			var nearestLoadingElement = clickedBtn.prev('.add-cart-loading');
			var nearestFailElement = clickedBtn.prevAll('.add-cart-fail');

			clickedBtn.hide();
			nearestLoadingElement.hide();
			nearestFailElement.show();
		}

		function addToCartSuccess(response) {
			var clickedBtn = $(this);
			var nearestLoadingElement = clickedBtn.prev('.add-cart-loading');
			var nearestSuccessElement = clickedBtn.prevAll('.add-cart-success');
			var nearestFailElement = clickedBtn.prevAll('.add-cart-fail');

			if (response.Status && response.Status === 'Success') {
				clickedBtn.hide();
				nearestLoadingElement.hide();
				nearestSuccessElement.show();
				nearestSuccessElement.delay(1500).fadeOut(1000);

				//TODO: update the basket view
				var basketItemsContainer = $('.basket-items-container');
				console.log(response);

			} else if (response.Status && response.Status === 'Fail') {
				clickedBtn.hide();
				nearestLoadingElement.hide();
				nearestFailElement.show();
				nearestFailElement.delay(1500).fadeOut(1000);
			}
		}

		// ajaxActionLink remove functions:
		function removeFromCartBegin(arg1, arg2, arg3) {
			console.log('begin');
			console.log(arg1);
			console.log(arg2);
			console.log(arg3);
		}

		function removeFromCartFail(arg1, arg2, arg3) {
			console.log('fail');
			console.log(arg1);
			console.log(arg2);
			console.log(arg3);
		}

		function removeFromCartSuccess(arg1, arg2, arg3) {
			console.log('success');
			console.log(arg1);
			console.log(arg2);
			console.log(arg3);
		}
	</script>
}